<!doctype html>
<title>{% block title %}{% endblock %} Appiphany </title>
<link rel="icon" type="image/png" href="static/images/logo.png">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Bebas+Neue&family=Open+Sans:wght@500&display=swap"
    rel="stylesheet">

<body>
    <div class="full-body-container">
        <div class="welcome">
            <img src="{{ url_for('static', filename='images/logo.png') }}" />
            <h1 id="normal-c">Appiphany</h1>
        </div>
        <div class="top-text">
            <h2 class="descr">A Full-Featured App Recommender </h2>
            <p id="instructions" class="instructions">Input a description of an app you desire.<br><br> After
                searching,
                label the relevant and irrelevant results using the toggle for each app, then finetune your results
                using the "Improve the Search" button.</p>
            <div class="input-box" onclick="sendFocus()">
                <img src="{{ url_for('static', filename='images/mag.png') }}" />
                <input placeholder="Describe An App" id="filter-text-val">
            </div>
            <!--       <div class="input-box" onclick="sendFocusApp()"> 
                <img src="{{ url_for('static', filename='images/mag.png') }}" />
                <input placeholder="List Similar Apps" id="temp"> 
            </div> -->
        </div>
        <div class="button-box">
            <button onclick="filterText()" class="button">Search!</button>
            <button onclick="rocchio()" class="button">Improve the Search</button>
            <button onclick="advSettingsToggle()" class="button" id="f_button">Filters</button>
        </div>
        <div class="advanced-settings" id="adv">
            <div class="price">
                <span class="slider-label">Max Price ($)</span>
                <input type="number" class="slider-input" min="0" max="100" value="100"
                    onchange="this.nextElementSibling.value = this.value" />
                <input type="range" class="slider" id="price" name="price" min="0" max="100" value="100"
                    onchange="this.previousElementSibling.value = this.value" />
            </div>

            <div class="lower-settings">
                <div class="iap">
                    <label class="switch">
                        <input type="checkbox" onchange='rel_toggle(this,"${appId}")' id="iap" name="iap" checked>
                        <span class="relevant-slider round"></span>
                    </label>
                    <a class='relevant-options-IAP' style='color:black'>In-App Purchases Allowed?</a>
                </div>

                <div class="min-rating">
                    <div class="rate">
                        <input type="radio" id="star5" name="rate" value="5" />
                        <label for="star5" title="text">5 stars</label>
                        <input type="radio" id="star4" name="rate" value="4" />
                        <label for="star4" title="text">4 stars</label>
                        <input type="radio" id="star3" name="rate" value="3" />
                        <label for="star3" title="text">3 stars</label>
                        <input type="radio" id="star2" name="rate" value="2" />
                        <label for="star2" title="text">2 stars</label>
                        <input type="radio" id="star1" name="rate" value="1" />
                        <label for="star1" title="text">1 star</label>
                    </div>
                </div>
                <label for="min-rating">Minimum Star Rating</label>
            </div>
        </div>

        <div id="answer-box">

        </div>
    </div>

    <!-- Histogram helper -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <script>
        var hidden = true
        function advSettingsToggle() {
            hidden = !hidden;
            var filters = document.getElementById("adv");
            var f_button = document.getElementById("f_button");
            if (hidden) {
                filters.style.display = "none";
                f_button.style.backgroundColor = "#666666"
                f_button.style.color = "#ffffff"
            } else {
                filters.style.display = "flex";
                f_button.style.backgroundColor = "#ffffff"
                f_button.style.color = "#000000"
            }
        }
    </script>

    <script>
        // We can use local_storage if we want to memorize values between pages (or even use cookies)
        // Currently don't use because not necessarily and/or lazy
        //localStorage.setItem('rel', '[[]]');
        //localStorage.setItem('irrel', '[[]]');
        //localStorage.setItem('rankings', '[[]]');
        //localStorage.setItem('iter', '0');

        var rel = [[]];//localStorage.getItem('rel');
        var irrel = [[]];//localStorage.getItem('irrel');
        var rankings = [[]];//localStorage.getItem('rankings');
        var iteration = -1;//localStorage.getItem('iter');
        const show_top_x = 10;

        const rel_color = "#75ba88";
        const irrel_color = "#b06e68";

        function answerTemplate(appId, title, titleDesc, rating, icon, url, topics) {
            return `<div id='${appId}' style='flex-direction:column'>
                <div class='answer-wrapper'>
                    <div class='answer-txt'>
                        <a target="_blank" rel="noopener noreferrer" href="${url}" class='entry'>
                            <h3 class='episode-title'><img class= "icon" src='${icon}' alt = "icon" width="50" height= "50">${title}</h3>
                        </a>
                        <p class='episode-desc'>${titleDesc}</p>
                        <p class='episode-rating'><img class= "icon" src='{{ url_for('static', filename='images/star.png') }}' width="15" height= "15">${rating}</p>
                        <p class='episode-desc'><u><b>Common review topics:</b></u> ${topics}</p>
                    </div>
                    <div class='answer-button-display'>
                        <button onclick='query_id("${appId}")' class='button'>Info</button>
                        <label class="switch"'>
                            <input type="checkbox" onchange='rel_toggle(this,"${appId}")' checked>
                            <span class="relevant-slider round"></span>
                            </label>
                        <p class='relevant-options' style='color:black'>RELEVANT</p>
                    </div>
                </div>
            </div>`
        }

        function sendFocusApp() {
            document.getElementById('temp').focus()
        }

        function sendFocus() {
            document.getElementById('filter-text-val').focus()
        }

        // Info box
        function info_box(appId, descriptionHTML, installs) {
            return `<div id='${appId}-extra-info' style='border:1px solid black;padding:10px;border-radius:5px'>
                <div class='histogram'>
                    <canvas id="${appId}-ratings"></canvas>
                </div>
                <div class='advanced-info'>
                    <p class='desc-html'>${descriptionHTML}</p>
                    <p class='app-installs'>${installs} installs!</p>
                </div>
            </div>
            `
        }

        // Make a histogram from settings
        // Not sure how to get rid of the frequency thing on the sides
        // Credit to ChartJS open source
        // Can make it a gradient for the histogram coloring
        function rating_histogram(appId, histogram) {
            const x_vals = [0.5, 1.5, 2.5, 3.5, 4.5];
            const y_vals = Object.values(histogram);
            const data = x_vals.map((k, i) => ({ x: k, y: y_vals[i] }));

            // Red
            const backgroundColor = Array(x_vals.length).fill('rgba(255, 99, 132, 0.2)');
            const borderColor = Array(x_vals.length).fill('rgba(255, 99, 132, 1)');
            // Highlight the 5 star ratings in blue
            backgroundColor[x_vals.length - 1] = 'rgba(54, 162, 235, 0.2)';
            borderColor[x_vals.length - 1] = 'rgba(54, 162, 235, 1)';

            context = document.getElementById(appId.toString() + '-ratings').getContext('2d');
            return new Chart(context, {
                type: 'bar',
                data: {
                    datasets: [{
                        label: 'Frequency',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1,
                        barPercentage: 1,
                        categoryPercentage: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    scales: {
                        //xAxes: {
                        //    gridLines: { display: false }
                        //},
                        x: {
                            type: 'linear',
                            offset: false,
                            grid: {
                                offset: false,
                                display: false,
                            },
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Stars',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frequency',
                                font: {
                                    size: 14
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                title: (items) => {
                                    if (!items.length) {
                                        return '';
                                    }
                                    const item = items[0];
                                    const x = item.parsed.x + 0.5;
                                    return `${x}★`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function query_id(appId) {
            let xtra_info = document.getElementById(`${appId}-extra-info`)
            if (xtra_info) { // Toggle
                xtra_info.remove();
            }
            else { // Query info
                console.log("Querying: " + appId.toString())
                fetch("/inforeq?" + new URLSearchParams({ appId: appId }).toString())
                    .then((response) => response.json())
                    .then(data => data.forEach(row => {
                        let info_div = document.createElement('div')
                        info_div.innerHTML = info_box(row.appId, row.descriptionHTML, row.installs)
                        document.getElementById(row.appId.toString()).appendChild(info_div)
                        rating_histogram(row.appId, row.histogram)
                    }));
            }
        }

        // need some fixing and extra checks for duplicates...
        // we will change this to become a "TOGGLE REL/IRREL button"
        function rel_toggle(obj, appId) {
            console.log("________________________________")
            if ((index = rel[iteration].indexOf(appId)) > -1) { // In rel
                console.log("Found in rel @ " + index);
                rel[iteration].splice(index, 1);
                irrel[iteration].push(appId);
                // obj.style.backgroundColor = irrel_color;
                // obj.innerHTML = "Irrelevant";
                document.getElementById(appId).style.opacity = 0.3;
            }
            else if ((index = irrel[iteration].indexOf(appId)) > -1) { // In irrel
                console.log("Found in irrel @ " + index);
                irrel[iteration].splice(index, 1);
                rel[iteration].push(appId);
                // obj.style.backgroundColor = rel_color;
                // obj.innerHTML = "Relevant";
                document.getElementById(appId).style.opacity = 1;
            }
            else {
                console.error(`Unexpected toggle call, ${appId} not member of either.`);
            }
            console.log("Relevant: " + rel[iteration].toString());
            console.log("Irrelevant: " + irrel[iteration].toString());
        }

        function filterText() {
            iteration = 0;
            rel = [[]];
            rankings = [[]];
            irrel = [[]];
            var minimum_rating;
            if (document.getElementById("star1").checked) { minimum_rating = 1 }
            if (document.getElementById("star2").checked) { minimum_rating = 2 }
            if (document.getElementById("star3").checked) { minimum_rating = 3 }
            if (document.getElementById("star4").checked) { minimum_rating = 4 }
            if (document.getElementById("star5").checked) { minimum_rating = 5 }

            document.getElementById("answer-box").innerHTML = "";
            console.log("Searching: " + document.getElementById("filter-text-val").value + "...");
            fetch("/apps?" + new URLSearchParams({
                title: document.getElementById("filter-text-val").value
                , min_rating: minimum_rating
                , max_price: document.getElementById("price").value
                , iap: document.getElementById("iap").value
            }).toString())
                .then((response) => response.json())
                .then((data) => data.forEach(row => {
                    let tempDiv = document.createElement("div");
                    // tempDiv.innerHTML = answerBoxTemplate(row.title, row.descr, row.imdb_rating)
                    rankings[iteration].push(row.appId);
                    let len = rankings[iteration].length;
                    if (len <= show_top_x) {
                        rel[iteration].push(row.appId);
                        //console.log(rel[iteration][len - 1]);

                        tempDiv.innerHTML = answerTemplate(row.appId, row.title, row.summary, row.scoreText, row.icon, row.url, row.topics);
                        document.getElementById("answer-box").appendChild(tempDiv);
                    }
                }));
        }

        function rocchio() {
            iteration++;
            rankings.push([])
            console.log("Performing Rocchio Iteration" + iteration);
            // document.getElementById("answer-box").innerHTML = "yeah, we're working on our rocchio";
            rel_json = JSON.stringify(rel)
            console.log(rel_json);
            console.log(typeof (rel_json));
            document.getElementById("answer-box").innerHTML = ''
            fetch("/rel-feed?" + new URLSearchParams({ title: document.getElementById("filter-text-val").value, rel: JSON.stringify(rel), irrel: JSON.stringify(irrel), iter: JSON.stringify(iteration) }).toString())
                .then((response) => response.json())
                .then((data) => data.forEach(row => {
                    let tempDiv = document.createElement("div");
                    // tempDiv.innerHTML = answerBoxTemplate(row.title, row.descr, row.imdb_rating)
                    if (rankings.length !== iteration) {
                        rel.push([]);
                        rankings.push([]);
                        irrel.push([]);
                    }
                    rankings[iteration].push(row.appId);
                    let len = rankings[iteration].length;
                    if (len <= show_top_x) {
                        rel[iteration].push(row.appId);
                        //console.log(rel[iteration][len - 1]);

                        tempDiv.innerHTML = answerTemplate(row.appId, row.title, row.summary, row.scoreText, row.icon, row.url, row.topics);
                        document.getElementById("answer-box").appendChild(tempDiv);
                    }
                }));
        }

    </script>
</body>